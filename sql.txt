
psql "host=c-groupe3.3i2a7yekjrai5q.postgres.cosmos.azure.com port=5432 dbname=netfloox user=citus password=floox2024! sslmode=require"

-- public.castview source

CREATE MATERIALIZED VIEW public.castview
TABLESPACE pg_default
AS SELECT tb.tconst,
    tb."primaryTitle",
    tb."titleType",
    tb."isAdult",
    tb."startYear",
    tb."endYear",
    tb."runtimeMinutes",
    tb.genres,
    avg(rt."averageRating") AS "averageRating",
    avg(rt."numVotes") AS "numVotes",
    string_agg(DISTINCT cw.directors, ','::text) AS directors,
    string_agg(DISTINCT cw.writers, ','::text) AS writers,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category ~~ 'act%'::text) AS actor,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'director'::text) AS director,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'writer'::text) AS writer,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'producer'::text) AS producer,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'cinematographer'::text) AS cinematographer,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'composer'::text) AS composer,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'editor'::text) AS editor,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'production_designer'::text) AS production_designer,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'self'::text) AS self,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'archive_footage'::text) AS archive_footage,
    string_agg(DISTINCT tp.nconst::text, ','::text) FILTER (WHERE tp.category = 'archive_sound'::text) AS archive_sound
   FROM "titleBasics" tb
     LEFT JOIN "titleRatings" rt ON tb.tconst::text = rt.tconst::text
     LEFT JOIN "titleCrew" cw ON tb.tconst::text = cw.tconst::text
     LEFT JOIN "titlePrincipals" tp ON tb.tconst::text = tp.tconst::text
     LEFT JOIN "namesBasics" nbt ON tp.nconst::text = nbt.nconst::text
  GROUP BY tb.tconst
WITH DATA;

-- View indexes:
CREATE INDEX castview_tconst_idx ON public.castview USING btree (tconst);